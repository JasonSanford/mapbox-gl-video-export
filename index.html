<!DOCTYPE html>
<html>
<head>
    <title>Mapbox GL JS debug page</title>
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <!-- <link rel='stylesheet' href='../dist/mapbox-gl.css' /> -->
    <style>
        #map { width: 960px; height: 540px; }
    </style>
</head>

<body>
<div id='map'></div>

<script src='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.js'></script>
<script src='https://unpkg.com/@mapbox/polyline@1.1.1/src/polyline.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.1.1/mapbox-gl.css' rel='stylesheet' />

<script type="module">
import loadEncoder from 'https://unpkg.com/mp4-h264@1.0.7/build/mp4-encoder.js';
import {simd} from 'https://unpkg.com/wasm-feature-detect?module';
const encodedPolyline = 'qbieFxwwxUPa@@O@MBK@O@M@K?M?K?IAKAOAKAKAKAI?M?O?M?K?OBIDQBKBKBKDMBMDM@O@MBK@K@OBMBGXk@FMFKDKDKDGDKFKJUFIDIDIFKFIDIFKDIDIDIDIFIDKDGDIDKDIFKDKHKDIDIDIDIDIDIFIFIFGFIFKDIFKDIFIFIBETw@BIFGBKDIBKBMBMBK@KDM@MBMBK@O@Q@M@M@M?K?O?M?OCMAOCMGMAMCQAKCOCMAM?ICu@?M?KCKCIEIGI?KFGHCJBL@JBJDHBJDHDNHHDHDNHPHVJH@L@LBJDH@HBJ@H@H?F?HA??j@EHEFEFEFEFEFIHEJEJCFCJCJCHAHAHAHAFAH?HAHAH?LALAJAJ?L?H?H?H@J@J?H?H?H?J@LBJDLDRJPFLDDBr@HJBHBLBLDLDH@JBLBJBH@J?J?H@H?H?L@H?HBHBH@JDJ@H@J@J?J?HCJIHIDIFGBIDMDO?K?M?O@M?M?M@KDKBKDIFKBKDKDO@KDO@O@O?ODI@KBQBO?O?O?M?Q@M@OBM?EXa@?M?Q?M?OEOCOEMAKCKCKEIGQEMEKCICKEQAKAK?O?S?K?M@KBMBMBMBMBKDM@M@M@K?M@S@M?[@S?O?K?IQy@?O?MAKAM?K?KAM?K?M@KBKDIFGHGJEJEHCHGFEFGDKDI@K?MIKEIKKEKEIGKEMCOAM?M?M?O@K@MBK@GDu@?MAMEKEMCKCQEMAMCMCOAMEMAKCK?MAK?O?K?CJ?@m@E_A?{@Is@Be@JuACy@_@uAUe@UYWUEk@MGBKNBIOMQFOGMHCI[DQ@KLS?[TGIUASJWFy@Ba@Gg@Aq@DOA{@_@YU???UTMVSVGNIBGC?WJa@Mk@`@mC\w@TU\QTANFH\F@Vc@HY@GHo@?_@F[AABC?AICGGEGAM?M@M@KEKGIGE??W[CKCK?K?O?M?M@K?M?KAKCKEIEKEGKIIEGGGGGIGIGKGIEIGIKEKGGGGKAM??[QGEGGIGEGGEEIGGEGCICM?O?KFIJCHCHAJCH?LAJEHAJAJCHCJCLCJCFCHCHEJEDI@?NIHEHGFEBK@M?MEKCKGIEGGEGIAK?K@MCKCIEIAO?M?KBKHCJAHAHEBICIEIGGEIEKAMDMHCFEHCJCH?H???XGHEFIBKBKGIGEMKEGCM?K?O?KCKGGMEICIC??WEM?ICIECI?MFKFAHCHCDI?M?K@KFGFI?KCKBKHEHAB?NGFEEIGCICHEFCHGBIIEKCKCBKHEFEEIIEEGFCEKGIBKJCHEEKKAGEFGHCGGKABKHGDIGIIEIEEEDEFI@?DQ?MGIEGAMFKFGDGHKDK@I?M?MCMAM?M?K@K@O@K??F]@M@K?M@M?MCMCIK?GHEFGDKE@MFIDGFKDGFKDI@MICG?IDIFIFGDI?IG?K@ODKFGFGDEHEDG?KIEGAICICGICGGEIEGGGIGKCCUMI?KCICGGEIGGIGIEGGGGGGCIAKDEH?H?J?HACKIEICIGGCICGEICKAG@I?E?W?K?GCGCGGGEIEKMGGEGIEEGCMAKCKCIIECCYQGGGGEKGIEIGGEGIEKGGCGGEIEIEKCKGGEEIEEGIIGGCEe@g@EKGIGGEICICKCMCOEQEMGIIKIKGKGKEGISI[AM?K@KBKBMBI@KBK@M?K?K?G?k@?O?M?K?QEKCKCKEMEKEKI[CKEWEQCMEQAKAMEM?KCKCKEKEIEKEGEIEIGKCICKCIEMEOEOCIEIEKEIGIEIGEKOKMEGCEMk@COEKEKCMEIGGGGGGEIIKCMEKCKEIEIIGIKGGMOEIGMEKEKGIGIIGIKEIGIEIIOEIGGEIGGGG??YQKCGEIAICGCGCIGGEIKGMGKCMEMEIGUEIEOAQAQ?SAO?O@O?M?MAMAKCMCMCKCOCICIEMAICKCIGOGOCIEOEMAICMCMAKCIGu@AMCIEIEIEKGMCICMEICMAKCICKAMEICOCIESAMAIAKCOAKCMGMIIEGIIGGEGA?i@SIGEIEGGKIIEGEIGIEGGGGEEJ@J?L?JBJ@LBH?L@NI?EIEIEICGGG?AQAIDEJCL?J?J?L?LGFIAIEGGEGIIKCM?CJEJ?LCJEFI?IAKAICI?C?WIGNEHICGGGEUDI@IHI@I@K?IAGEICKAIAICEGGICIGKIGIIIEEE_@_@M?I?K@IBIDGDIBGDGHGFIDMFGDGHGHEFGHIHIHGHIFIBI@I???a@EI?M@K?I?M?K@IDEFEHAJ?LALCJI?IEKCICEIEKIIIAIEIGEGAK?M?KGKEIKEKGKGICGGEEEOEKCKCKCKAMAO?K?K?K?M@OBM@K?M@OBM??@u@DIDIDIFKBMBK@O@M?K?KCKEMEOCMCKCKGGGAIFCJEFELCLEHGIAKAO?K?M?KCKEIIAIAKEGIAKAK?M?K?KCKEOEKEMEKEIGGI?K?KDEFELGLCLENEJGJGHGFEHEHCJAJ?J?LAJGHEJ?JAL?LCJGHI?C?W^AJGE@MICI@CMAK?K?KAKAM?K@KBM@KBMBO?K@K?KICGFEFKJMHGFIDEFIFI@I@I@IFEHEHCJAJCJGFEHAJ?J?LCBQh@G@I@ICAKEKCK?KAO?K?K?K?MAOAKAKCMCKGIIBEHGJEJCJELEJEGEII@KFIBIFEJGJCDc@b@OBIBIBI@GDI@K?IAIEICIAI?I@GDKDEFGDGFK?K?G@GFEJEJI@I?IAG?GJEHEJC@UPCK?KEIIAI?I?K@GJEHCL?LEHGFKHIDEHGFK@I?K?G@I?ICIKIEK?IFIDKDIDA@u@b@K?UFI@I?CJKJKJCJ?JBL@JBL?J?P?L?N?PALEHIFI?I?IEEGGIGGIIGKGIGKKIIIKEGEM?K?EHEPEJ?NCPCLCLCPAJALCNELELAJEPEJA@UfAGBKBK?MAMEKGIEKCMCQEOCKCG?KAIAI?MAI?I?K?I?I?G?I?I?I@K@GDKD[JQPGHGFCD_@p@ANAPCNAJALALCPANCJAL?LCRALALCNCJCJEHEJGJIJEHCJEJEHEHIHEFGHEHCHEHEJAJAL?JBL?JALCJCJAJ?N?L?J?J?L?J?L?N@L@N@J@L@J@J@N@J?J??V|A?J?NBN?L@J@N?J@J@J@J@JBJBJDLDJDFFHHFJ@L?J?FIBKBKFEHCH?JBFDFHDHFFBM@OBK@K?K@O@KHAFCJCJ?HBHJJLJJFFFD@B`@x@?R?NBJDNBJDJFJDLFLDLDFBL?L?LAJ?J?N@JHLFHDJ?J?LCNCLAL?J@NFLBJFHFHDJDHDHFLFHDHDH@LBL?N@L@J@F?z@?L?P?PAJAJAJ?J?J?J?N@JBL@J@J@JDXHJHFFDH@J@FFFFBJBJDJDFHBHFHDFHBNBLBJ@JBBTRF@H@H?H?H?H?H?H?F?CHEHH@H?L?J@GFGBGH?JHBDHCJBJFBFF?J?JBJH@@HJRFP?J@L@H@JBJDJBHFHDHDHFFFHFFBHDHDJBLFJHJFDFDHJFDDFHDHFFDFFJBFDFDHHDJBJBLDJDJDHDJDJDHBJ??Jb@BJBJBLBHBJBLFJDHDLBH??Jd@?L?JBNBLDNBLDJDJDHBJDHDJBJDJDNDHDJ@LBJ@JBDNb@?JBJ@H?N?JEJGFI@M?GAKAK?IAKAG?p@D@PBJ?JAHEJEHEHCDL[HCHEJCFEJ?J?F?L@HBL@H@H@J@JDF@HBHBF@JBDB`@TH?HBHDHDHFHHFDFFFFDFFFBHFH?J?J?JCJAF@GBK?K?K?KGICIGGEGGGGGGEIIIGIEIEICI?a@UECKCGAICICGAKEKAIAIAMAICMAG?K?K?GDKBIDIBMZBEDIDIDK@I?KCKAQq@EF?J@H@J?J@F@L?HAFGDK?K?OAICK?KOc@CEAKCKAMEKEIEOEKCKEKEICKEIEKEKCMEOCMCO?K?MKe@??CIEMEIGKCMCKCICMCKCKKc@??CKEIEKEKEIEKEKCMCKEKIIGEGEKCGGGEIGIEEGGEIKGEGEIKGKCMEKEICIGGGIGGEIEIGICIEKCKAKAIAM?KGQKSAIIACK?K?KGGGCCKBKEIIC?KFIFCFGKAM?I?IADIBIG?I?I?I?I?I?I?IAGAUSCCAKCKCMCOGIIEIGICEGEKCKCKGGGGKAIAGEIGIKEYAKAKAKCMAK?O?K?K?K@K@K@K?Q?Q?M?{@AGAKAM?OCMAMEIEIGIGMEIEIEKGIGICKGMAO?K@MBMBO?M?KEKGIIMAK?O?K@K?M?MCMEGEMGMEMGKEKCKEOCK?O?Sa@y@ACGEGGKKKMIKICK?KBGBI@AJAN?JAJCJANCLGGEIGIGEKCI?IBGDCJCJGHK?M?KAIGGIEGEKEMCKCKAKAKAKAK?KAOAK?MCO?O?KW}A???KAKAOAKAKAMAKAOAM?O?M?K?M?K?K?M?O@KBKBK@M?KCM?K@M@KDKDIBIDIFIDGHIDIDIDKBKDIHKFKDKDIBKBKBO@M@MBS?M@MBK@OBQ@M@M@KBO@Q@O^q@BEFGFIPQZKJEFEJAHAH?H?F?H?H?J?H?H?L@H?H@J@F?JBNBPDLBJBHDJFLDL@J?JCFCTgA@ADKDQ@KDMDMBO@M@KBQBMBMBQ?ODKDQDIJ?L?FDJDHHJHFJFHFJHHFFFHDFHDH?H?HGDI@M?Q?O?M?Q?KCMAKCM?KBKJKJKBKH?HATGJ?t@c@@AHEJEHEHGJ?HDHJHBH?FAJ?H?JAFGDIHEJIFGDI?MBMDIFKJAH?H?H@DH?JBJTQBADKDIFKF?H@H?HADKDKFGFAJ?J?FGFEDGJEFEHAH?H@HBHDH@J?HAFEHAHCHCNCb@c@BEFKDKHGHCJGHADHDFDKDMBKDKFKDIHCFHBJBL@J@J@N?L?J?J?J@N?JBJDJ@JHBHAFAPi@BC?M?K@KDIFGBK@KBKDIDIHGHAHAHAHGDGHEFGLIJKDGFGHB?JAJ?JCNCLAJCLAJ?J@L@J?J?J@JBLHAHBALFD@KV_@B?H?FIBK?M@M?KDKFI@K?M?K@KBKDIDIFGFIFKDKDOBMFMDMDGJEJ?H?FFDHDJDLDJDNBJ?J?J?L@J@JFHJDH@H@DHBJ?J?L?J@N@JFHDIBMDMDGBKHGF@FFBJBJBLDNDLBJ?J?JALANCJCLGJEHEHEHAt@??CLAN?LAJCLAN?L?J?J?J@N@LBJBJBJDJDNDDFFHBJFJFJDDHFJ?J?L@JDFHFHDH@HHDJDHHBJBHDH?BK@M?M@KDIDGHEJAL?H?J?LAH?`@D??H?HAHCHGFIHIHIFIDGFIFIFELGHEFGFIFEHCFEHEHCJAH?L?^^DDHDHHHFFJBHFHDFHBH@J@HBFDH@J?HAHAHIHATEFDFFHBDIFOVHB?H?HBJ@H@H?DGBK?MDKBKL?JBHHDFFFHDH@FG?M?M?K?KBMDKHEP@?@FFBFDHDHDHH?AO?MCIAMCK?K?MAKDKFDFFDFFHDHDFHHFJDFDHHFh@R@?DFFFHHDFHHFLBL@JBN@J@H@LDRBHBNDH@LBJBH@JBLDHBLBHFLDJDHDHBH@LFt@BH@JBLBL@HDLDNBHFNFNBHBJ@HDLBHBHBNBJBLBL@J@L?L?LAN?N@N?R@P@PDNDHFTDHDLBLFJFLHJFDHFFBFBHBH@FDJBXP??FFFFDHFFDHHNDHFHDHHJHFFHFHDJDJFLDHLNFFHJHFDHDHBJDJBLHJDHFFFFFFDHBLDJDJBNLj@BDDFJLJNFDDHFHDHDJDHBHDNDNDLBHBJBHFJDHDHDFDJDHDJBJBJ?JDL@L@JDPBLDPDVBJHZDJDJDLBJBJDJ?P?J?L?N?j@?F?J?JALCJAJCHCLCJAJ?J@LHZHRDFFJFJHJHJFHDLDPBNBLBJBHDHFFFHDJd@f@BDFFHHDFHDDDFFBJDJDHDHFFFBJFHDDFFFDHFHDJFFFFXPBBHDBHBJ@JBLDFHDDFFFJLHDFDFFFBFBJ?V?D?H?FAJ@HBFDHBFBHFHBHDBJI@K?I?I?ED@JBHFFFFFFHDHFFFDHFFHBJBH?TLBBFJFHFF@?A@b@Zf@NDLc@JCb@MRT?PMP?V?JBPFHDFTFb@HTL\Fz@Nt@Xl@d@hBx@pARb@HND@h@HJJdAbAPF\HZHNPHLPf@Zb@n@b@X^JHd@Ln@`@BTBB??T^J\F|@BRR`ARh@^pBXt@F^EnAMfAAj@I\CZAj@Bd@Kt@Ud@I\QzAJbAHZDZDh@Cd@KFOs@S[Ou@Qg@Kk@GOCMCAA?C@AFGXE\B^VjAJb@Ff@?LMzAWnAO^EN?\GT]p@Sx@[j@Wn@UbAWh@GVQXGd@IDDq@?o@Fi@@m@AYQb@k@jAIr@IXOT[lBM?WWEGCZEd@Kd@EBGBIQQYCKE]CGG|@A`@@XBHBJJNNHBDBh@DRJXPVHHJ?DC?ADCFEFGFEDIFEHEJEJAHAJ?J?JBJ?HDHBJFJFFFAJIBK?K?I?I?G?I?I?GBFDF@J@H?J@JBHDJBJ@BJI@G?K?G?K@HDFDHDFDLDFHI?IAIAIAI?DFFDFDJDHDFDIBI?IAKCKAKCGAIBFFFFJDFDFHDFFFLH@HIDI@EFDFFDJBDT@DBJANEFEH?J@JFHDHFDDFJBBJIFIDI@DFFFFFHDFDHDDFFHBL@L@JBLDHDNDHDFLLHJHJDJJJFHFFLLDFBN?JAJGFI@GCIIGGIKGGIKGEIEIEGEIGGGIGKMEGEIg@c@??EIKKEGKIIGGGKMIGIGGIGEGEIEIAICGAK?K@DHDHFHDJDHFHFHFHFHDH@J?LCJEFICIGIKGKGIGGIEKEKCGEGEIEGIIGGKGIEICIEIICI@?L@JBHDHDJBJDHBNBLBNDPBHDLBHBLBL@J@J@JGDIEGGGGEIEKGGGIGGIKGGGKg@i@?AICGEMEGGGIGE?J@LBJ@JDJBLDJBHDHFJFJFJFHDHBJBJ?J@LCHGEGGGMEIIMMSIOGGIEGEIEGEMIGGIIIIIIGGGGIKGKEGIAEFAL?J?N@J?LBJ@JDL@LBNBL@LDLBPBJDLDJ@L?LEt@AFCJALAJ?N?L?L@LBNDLFJDHDJJJDHHJ?LAJEHEJGFGDIFIBKDKDIFGFEHCJAJ?L?J@L?J?J@L@J?L?NPx@?H?J?NAR?ZALAR?LAJALALELCJCLCLCLCLAJ?L?J?R?N@J@JDPBJBHDJDLFPDHBJBJ@JDLBNDN?N?L?P?LY`@?DCLANAL?P?L?N?NCNCPAJEH?NANANENAJENEJCJGJEHCJEJAJ?L?LAL?N?L?JENELCHGFEHIHKHIBK?K?KAIAKAKEIAICICI?MAI?I?IAK?K?IAKCMCKCIAMEMEMCICKCs@IECMEQGSKMEKEMCKAI?I?I?K?KAIAI?I?M?K?K@M@M@I?I@I@I?G@I@I@I@I@KBKBGBKBKDIDGHGDGDGDGDIDk@D??I@G?I?IAKAICIAKEMCMAIAWKQIOIIEIEOIIEKEICKEKCMAKCIBGF?JFHDHBHBJ?J?LBt@?H@LBLBN@JBP@LFLBL@NBL?N?L?N?JALALALAPANCJCLALELAJCJCLCLCJEHCJGFCHUv@CDGHGHEHGJEHGJGHGFGHGHEHEHEHEHEHEHIJEJGJEHEJEHEFEJGHEHEHEHEHGJEHGHGJEHEHGHKTGJEJEFEJEJGJGLYj@CFCLANAJCJALANELCLELCJCJCJEPCH?N?J?L?N?L@H@J@J@J@N@J?H?J?LAJALANCJALANQ`@';
const wholeGeometry = polyline.toGeoJSON(encodedPolyline);
const data = {
    type: 'LineString',
    coordinates: []
};

mapboxgl.accessToken = 'pk.eyJ1IjoiamNzYW5mb3JkIiwiYSI6ImNrZG1kdnU5NzE3bG4yenBkbzU5bDQ2NXMifQ.IMquilPKSANQDaSzf3fjcg';
// Yosemite Valley - 37.7312813,-119.6055247
const map = window.map = new mapboxgl.Map({
    container: 'map',
    center: [-119.5413507, 37.7475183],
    zoom: 13.2,
    pitch: 61,
    bearing: -20,
    style: 'mapbox://styles/mapbox/satellite-v9'
});

async function animate() {
    // do all the animations you need to record here
    map.easeTo({
        bearing: map.getBearing() + 180,
        center: [-119.5339927, 37.74725],
        duration: 8000,
        easing: t => t
    });
    // wait for animation to finish
    await map.once('moveend');
}

map.on('load', async () => {
    map.addSource('dem', {type: 'raster-dem', url: 'mapbox://mapbox.mapbox-terrain-dem-v1'});
    map.setTerrain({source: 'dem', exaggeration: 1.5});

    map.addSource('route', {
        type: 'geojson',
        data
    });
    map.addLayer({
        'id': 'route',
        'type': 'line',
        'source': 'route',
        'layout': {
            'line-join': 'round',
            'line-cap': 'round'
        },
        'paint': {
            'line-color': '#ff0000',
            'line-width': 3
        }
    });

    let i = 0;
    let timer = window.setInterval(() => {
        if (i < wholeGeometry.coordinates.length) {
            data.coordinates.push(wholeGeometry.coordinates[i]);
            map.getSource('route').setData(data);
            i++;
        } else {
            window.clearInterval(timer);
        }
    }, 10);
    // wait until the map settles
    await map.once('idle');

    // uncomment to fine-tune animation without recording:
    // animate(); return;

    // don't forget to enable WebAssembly SIMD in chrome://flags for faster encoding
    const supportsSIMD = await simd();

    // initialize H264 video encoder
    const Encoder = await loadEncoder({simd: supportsSIMD});

    const gl = map.painter.context.gl;
    const width = gl.drawingBufferWidth;
    const height = gl.drawingBufferHeight;

    const encoder = Encoder.create({
        width,
        height,
        fps: 60,
        kbps: 64000,
        rgbFlipY: true
    });

    // stub performance.now for deterministic rendering per-frame (only available in dev build)
    let now = performance.now();
    mapboxgl.setNow(now);

    const ptr = encoder.getRGBPointer(); // keep a pointer to encoder WebAssembly heap memory

    function frame() {
        // increment stub time by 16.6ms (60 fps)
        now += 1000 / 60;
        mapboxgl.setNow(now);

        const pixels = encoder.memory().subarray(ptr); // get a view into encoder memory
        gl.readPixels(0, 0, width, height, gl.RGBA, gl.UNSIGNED_BYTE, pixels); // read pixels into encoder
        encoder.encodeRGBPointer(); // encode the frame
    }

    map.on('render', frame); // set up frame-by-frame recording

    await animate(); // run all the animations

    // stop recording
    map.off('render', frame);
    mapboxgl.restoreNow();

    // download the encoded video file
    const mp4 = encoder.end();
    const anchor = document.createElement("a");
    anchor.href =  URL.createObjectURL(new Blob([mp4], {type: "video/mp4"}));
    anchor.download = "mapbox-gl";
    anchor.click();

    // make sure to run `ffmpeg -i mapbox-gl.mp4 mapbox-gl-optimized.mp4` to compress the video
});

</script>
</body>
</html>
